<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ArcGIS Map with OSRM Routing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/dark/main.css">
  <script src="https://js.arcgis.com/4.31/"></script>
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #authDiv {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 100;
    }
    #authDiv input, #authDiv button {
      margin: 5px;
    }
    #routePanel {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 100;
      width: 200px;
    }
    #routePanel button {
      width: 100%;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <div id="authDiv">
    <label for="clientIdInput">Client ID: </label>
    <input type="text" id="clientIdInput" placeholder="Enter Client ID">
    <button id="loginButton">Login</button>
  </div>
  <div id="routePanel">
    <label>Selected Lookout: <span id="selectedLookoutName"></span></label>
    <label>Selected Parking: <span id="selectedParkingName"></span></label>
    <button id="clearRouteButton">Clear</button>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/geometry/Polyline",
      "esri/geometry/Point",
      "esri/identity/IdentityManager",
      "esri/identity/OAuthInfo"
    ], function(
      Map, MapView, FeatureLayer, GraphicsLayer, Graphic, Polyline, Point, IdentityManager, OAuthInfo
    ) {
      console.log("ArcGIS API modules loaded successfully");

      const portalUrl = "https://mendelu.maps.arcgis.com";
      const redirectUri = "https://junkers4.github.io/JustForFun/"; // Must match ArcGIS app settings
      let oauthInfo = null;

      // Initialize map
      const map = new Map({
        basemap: "dark-gray"
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [21.2611, 48.7164],
        zoom: 13
      });

      // Graphics Layer for routes
      const graphicsLayer = new GraphicsLayer({
        title: "Routes"
      });
      map.add(graphicsLayer);

      // Lookouts Layer
      const lookoutsLayer = new FeatureLayer({
        url: "https://services3.arcgis.com/lOWgvXGCzs0MJj0p/ArcGIS/rest/services/ViewPoints_xvascak1_WFL1/FeatureServer/0",
        title: "Lookouts",
        outFields: ["*"],
        popupTemplate: {
          title: "{name}",
          content: "Click a parking spot to draw a route."
        },
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-marker",
            color: "#FF33A1",
            size: 10,
            outline: { color: "#FFFFFF", width: 1 }
          }
        }
      });

      // Parking Layer
      const parkingLayer = new FeatureLayer({
        url: "https://services3.arcgis.com/lOWgvXGCzs0MJj0p/ArcGIS/rest/services/allparking/FeatureServer/0",
        title: "Parking",
        outFields: ["*"],
        popupTemplate: {
          title: "{name}",
          content: "Wheelchair: {wheelchair}"
        },
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-fill",
            color: [51, 87, 255, 0.5],
            outline: { color: "#FFFFFF", width: 1 }
          }
        }
      });

      map.addMany([lookoutsLayer, parkingLayer]);

      // OSRM Route Function
      async function findRouteAlongPaths(startPoint, endPoint) {
        console.log("OSRM: Start point:", startPoint);
        console.log("OSRM: End point:", endPoint);
        const url = `http://router.project-osrm.org/route/v1/walking/${startPoint.x},${startPoint.y};${endPoint.x},${endPoint.y}?overview=full&geometries=geojson`;
        console.log("OSRM: Request URL:", url);
        try {
          const response = await fetch(url);
          console.log("OSRM: Response status:", response.status);
          if (!response.ok) {
            throw new Error(`OSRM HTTP error: ${response.status}`);
          }
          const data = await response.json();
          console.log("OSRM: Response data:", data);
          if (data.routes && data.routes.length > 0) {
            const coordinates = data.routes[0].geometry.coordinates.map(coord => [coord[0], coord[1]]);
            console.log("OSRM: Route coordinates:", coordinates);
            return new Polyline({
              paths: [coordinates],
              spatialReference: view.spatialReference
            });
          }
          throw new Error("OSRM: No routes found in response.");
        } catch (error) {
          console.error("OSRM route error:", error);
          throw error;
        }
      }

      // Login Button Event
      document.getElementById("loginButton").addEventListener("click", function() {
        console.log("Login button clicked");
        const clientId = document.getElementById("clientIdInput").value.trim();
        console.log("Client ID entered:", clientId);
        console.log("Redirect URI:", redirectUri);
        console.log("Portal URL:", portalUrl);

        if (!clientId) {
          alert("Please enter a valid Client ID.");
          console.error("No Client ID provided.");
          return;
        }

        try {
          oauthInfo = new OAuthInfo({
            appId: clientId,
            portalUrl: portalUrl,
            popup: true,
            redirectUri: redirectUri,
            popupCallbackUrl: redirectUri,
            authNamespace: "/sharing/rest"
          });

          console.log("OAuthInfo configured:", oauthInfo);

          IdentityManager.registerOAuthInfos([oauthInfo]);
          console.log("OAuthInfo registered");

          // Test popup support
          const testPopup = window.open("", "_blank", "width=600,height=400");
          if (!testPopup) {
            console.warn("Popup blocked by browser. Falling back to new window.");
            alert("Please allow popups for this site to enable a better login experience.");
          } else {
            testPopup.close();
            console.log("Popup supported by browser.");
          }

          IdentityManager.getCredential(portalUrl + "/sharing/rest", {
            oAuthPopupConfirmation: false
          }).then(function(credential) {
            console.log("User is signed in:", credential);
            document.getElementById("authDiv").style.display = "none";
            alert("Login successful!");
          }).catch(function(error) {
            console.error("Login failed:", error);
            alert("Login failed: " + error.message);
          });
        } catch (error) {
          console.error("Error during login setup:", error);
          alert("Error during login setup: " + error.message);
        }
      });

      // Variables for selection
      let selectedLookout = null;
      let selectedParking = null;

      // Click Event for Lookouts and Parking
      view.on("click", async function(event) {
        console.log("Map clicked at:", event.mapPoint);
        graphicsLayer.removeAll();
        const response = await view.hitTest(event);
        console.log("Hit test response:", response.results);
        const lookoutGraphic = response.results.find(result => result.graphic.layer === lookoutsLayer);
        const parkingGraphic = response.results.find(result => result.graphic.layer === parkingLayer);

        if (lookoutGraphic) {
          selectedLookout = lookoutGraphic.graphic;
          console.log("Selected lookout:", selectedLookout.attributes);
          document.getElementById("selectedLookoutName").textContent = selectedLookout.attributes.name || `Lookout ${selectedLookout.attributes.OBJECTID}`;
          view.popup.open({
            title: `Lookout: ${selectedLookout.attributes.name || 'Unknown'}`,
            content: "Click a parking spot to draw a route.",
            location: selectedLookout.geometry
          });
        } else if (parkingGraphic && selectedLookout) {
          selectedParking = parkingGraphic.graphic;
          console.log("Selected parking:", selectedParking.attributes);
          document.getElementById("selectedParkingName").textContent = selectedParking.attributes.name || `Parking ${selectedParking.attributes.OBJECTID}`;

          const lookoutPoint = selectedLookout.geometry;
          const parkingCentroid = selectedParking.geometry.centroid || selectedParking.geometry;
          console.log("Lookout point:", lookoutPoint);
          console.log("Parking centroid:", parkingCentroid);

          try {
            const routeGeometry = await findRouteAlongPaths(parkingCentroid, lookoutPoint);

            const routeGraphic = new Graphic({
              geometry: routeGeometry,
              symbol: {
                type: "simple-line",
                color: [255, 0, 0, 0.8],
                width: 2
              }
            });

            graphicsLayer.removeAll();
            graphicsLayer.add(routeGraphic);

            const parkingGraphic = new Graphic({
              geometry: parkingCentroid,
              symbol: {
                type: "simple-marker",
                color: [51, 87, 255],
                size: 10,
                outline: { color: "#FFFFFF", width: 1 }
              }
            });
            const lookoutGraphic = new Graphic({
              geometry: lookoutPoint,
              symbol: {
                type: "simple-marker",
                color: "#FF33A1",
                size: 10,
                outline: { color: "#FFFFFF", width: 1 }
              }
            });
            graphicsLayer.add(parkingGraphic);
            graphicsLayer.add(lookoutGraphic);

            view.goTo(routeGeometry);
            console.log("Route drawn successfully");
          } catch (error) {
            console.error("Error finding route:", error);
            alert("No route found. Drawing straight line as fallback.");

            const polyline = new Polyline({
              paths: [
                [parkingCentroid.x, parkingCentroid.y],
                [lookoutPoint.x, lookoutPoint.y]
              ],
              spatialReference: view.spatialReference
            });

            const lineGraphic = new Graphic({
              geometry: polyline,
              symbol: {
                type: "simple-line",
                color: [255, 0, 0, 0.8],
                width: 2
              }
            });

            graphicsLayer.removeAll();
            graphicsLayer.add(lineGraphic);

            const parkingGraphic = new Graphic({
              geometry: parkingCentroid,
              symbol: {
                type: "simple-marker",
                color: [51, 87, 255],
                size: 10,
                outline: { color: "#FFFFFF", width: 1 }
              }
            });
            const lookoutGraphic = new Graphic({
              geometry: lookoutPoint,
              symbol: {
                type: "simple-marker",
                color: "#FF33A1",
                size: 10,
                outline: { color: "#FFFFFF", width: 1 }
              }
            });
            graphicsLayer.add(parkingGraphic);
            graphicsLayer.add(lookoutGraphic);

            view.goTo(polyline);
            console.log("Fallback straight line drawn");
          }
        }
      });

      // Clear Button Event
      document.getElementById("clearRouteButton").addEventListener("click", function() {
        console.log("Clear button clicked");
        graphicsLayer.removeAll();
        selectedLookout = null;
        selectedParking = null;
        document.getElementById("selectedLookoutName").textContent = "";
        document.getElementById("selectedParkingName").textContent = "";
      });

      // Zoom to combined extent
      view.when(function() {
        console.log("Map view ready, zooming to extent");
        Promise.all([
          lookoutsLayer.when(),
          parkingLayer.when()
        ]).then(function([lookouts, parking]) {
          const extents = [lookouts.fullExtent, parking.fullExtent].filter(extent => extent);
          if (extents.length > 0) {
            const combinedExtent = extents.reduce((acc, extent) => acc.union(extent));
            view.goTo(combinedExtent).catch(function(error) {
              console.error("Error zooming to combined extent:", error);
            });
          }
        });
      });
    }, function(error) {
      console.error("Error loading ArcGIS API modules:", error);
      alert("Failed to load ArcGIS API modules. Please try again later.");
    });
  </script>
</body>
</html>
